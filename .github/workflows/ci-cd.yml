name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: strapi
          POSTGRES_PASSWORD: strapi
          POSTGRES_DB: strapi_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
      NODE_ENV: test
      HOST: 0.0.0.0
      PORT: 1337
      # Security variables for Strapi
      ADMIN_JWT_SECRET: test_admin_jwt_secret_12345
      JWT_SECRET: test_jwt_secret_12345
      API_TOKEN_SALT: test_api_token_salt_12345
      APP_KEYS: test_app_keys_12345,test_app_keys_67890
      TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
      # Disable telemetry in test environment
      STRAPI_TELEMETRY_DISABLED: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Wait for PostgreSQL
      run: |
        for i in {1..10}; do
          if pg_isready -h localhost -p 5432 -U strapi -d strapi_test; then
            echo "PostgreSQL is ready"
            exit 0
          fi
          echo "Waiting for PostgreSQL to start..."
          sleep 3
        done
        echo "PostgreSQL failed to start"
        exit 1

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps
        # Ensure pg is installed
        npm install pg --save

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: test

    - name: Seed test database
      run: NODE_ENV=test node scripts/seed-test-db.js
      env:
        DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
        NODE_ENV: test
        HOST: 0.0.0.0
        PORT: 1337
        ADMIN_JWT_SECRET: test_admin_jwt_secret_12345
        JWT_SECRET: test_jwt_secret_12345
        API_TOKEN_SALT: test_api_token_salt_12345
        APP_KEYS: test_app_keys_12345,test_app_keys_67890
        TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
        STRAPI_TELEMETRY_DISABLED: true

    - name: Run unit tests
      run: npm run test:ci

    - name: Start Strapi in background
      run: |
        # Start Strapi in development mode for testing
        nohup npm run develop > strapi.log 2>&1 & echo $! > strapi.pid
        echo "Started Strapi with PID $(cat strapi.pid)"
      env:
        NODE_ENV: test
        HOST: 0.0.0.0

    - name: Wait for Strapi to be ready
      run: |
        echo "Waiting for Strapi to start..."
        for i in {1..30}; do
          if curl -s -f http://localhost:1337/admin -o /dev/null; then
            echo "Strapi is ready!"
            exit 0
          fi
          echo "Waiting for Strapi to start... (attempt $i/30)"
          sleep 5
        done
        echo "Strapi failed to start. Last 100 lines of log:"
        tail -n 100 strapi.log || true
        exit 1

    - name: Run Cypress tests
      run: npx cypress run --e2e --browser chrome --headless
      env:
        CYPRESS_BASE_URL: http://localhost:1337
        CYPRESS_ADMIN_EMAIL: admin@example.com
        CYPRESS_ADMIN_PASSWORD: Admin123
        NODE_ENV: test

    - name: Stop Strapi server
      if: always()
      run: |
        if [ -f strapi.pid ]; then
          echo "Stopping Strapi server (PID: $(cat strapi.pid))"
          kill -9 $(cat strapi.pid) || true
          rm -f strapi.pid
        fi
        # Additional cleanup
        pkill -f 'node.*strapi' || true
      env:
        NODE_ENV: test
        DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
        HOST: 0.0.0.0
        PORT: 1337
        JWT_SECRET: test_jwt_secret_12345
        API_TOKEN_SALT: test_api_token_salt_12345
        APP_KEYS: test_app_keys_12345,test_app_keys_67890
        TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
        STRAPI_TELEMETRY_DISABLED: true

    - name: Wait for Strapi to be ready
      run: |
        echo "Waiting for Strapi to start..."
        timeout 180 bash -c 'until curl -s http://localhost:1337/admin > /dev/null; do
          echo "Waiting for Strapi..."
          sleep 5
        done'
        echo "Strapi is ready!"

    - name: Run E2E tests
      uses: cypress-io/github-action@v5
      env:
        CYPRESS_BASE_URL: http://localhost:1337
        CYPRESS_STRAPI_EMAIL: admin@strapi.io
        CYPRESS_STRAPI_PASSWORD: Admin123
        DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
        NODE_ENV: test
        HOST: 0.0.0.0
        PORT: 1337
        ADMIN_JWT_SECRET: test_admin_jwt_secret_12345
        JWT_SECRET: test_jwt_secret_12345
        API_TOKEN_SALT: test_api_token_salt_12345
        APP_KEYS: test_app_keys_12345,test_app_keys_67890
        TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
        STRAPI_TELEMETRY_DISABLED: true
      with:
        build: npm run build
        start: npm run start:ci
        wait-on: 'http://localhost:1337'
        wait-on-timeout: 180
        working-directory: ./
        record: false
        headed: false
        browser: chrome
        quiet: true
        config: "baseUrl=http://localhost:1337,defaultCommandTimeout=30000"

    - name: Stop Strapi
      if: always()
      run: |
        if [ -f strapi.pid ]; then
          echo "Stopping Strapi (PID: $(cat strapi.pid))"
          kill -9 $(cat strapi.pid) || true
          rm -f strapi.pid
        fi

  deploy-staging:
    name: Deploy to Staging
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: staging
    env:
      DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME || 'none' }}/sqe-strapi:staging

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME || 'none' }}
        password: ${{ secrets.DOCKERHUB_TOKEN || 'none' }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ env.DOCKER_IMAGE }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to Staging
      run: |
        echo "ðŸš€ Staging image pushed to Docker Hub: ${{ env.DOCKER_IMAGE }}"
        # Add deployment commands here

  deploy-production:
    name: Deploy to Production
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production
    env:
      DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME || 'none' }}/sqe-strapi:production

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test

  build:
    name: Build
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
