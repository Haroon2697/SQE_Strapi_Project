name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: strapi
          POSTGRES_PASSWORD: strapi
          POSTGRES_DB: strapi_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
      NODE_ENV: test
      HOST: 0.0.0.0
      PORT: 1337
      ADMIN_JWT_SECRET: test_admin_jwt_secret_12345
      JWT_SECRET: test_jwt_secret_12345
      API_TOKEN_SALT: test_api_token_salt_12345
      APP_KEYS: test_app_keys_12345,test_app_keys_67890
      TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
      STRAPI_TELEMETRY_DISABLED: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Wait for PostgreSQL
      run: |
        for i in {1..10}; do
          if pg_isready -h localhost -p 5432 -U strapi -d strapi_test; then
            echo "PostgreSQL is ready"
            exit 0
          fi
          echo "Waiting for PostgreSQL to start..."
          sleep 3
        done
        echo "PostgreSQL failed to start"
        exit 1

    - name: Install dependencies
      run: |
        npm ci --legacy-peer-deps
        # Ensure pg is installed
        npm install pg --save

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: test

    - name: Start Strapi in background
      run: |
        # Start Strapi in development mode for testing
        nohup npm run develop > strapi.log 2>&1 & echo $! > strapi.pid
        echo "Started Strapi with PID $(cat strapi.pid)"
      env:
        NODE_ENV: test
        HOST: 0.0.0.0
        PORT: 1337
        DATABASE_URL: postgresql://strapi:strapi@localhost:5432/strapi_test
        ADMIN_JWT_SECRET: test_admin_jwt_secret_12345
        JWT_SECRET: test_jwt_secret_12345
        API_TOKEN_SALT: test_api_token_salt_12345
        APP_KEYS: test_app_keys_12345,test_app_keys_67890
        TRANSFER_TOKEN_SALT: test_transfer_token_salt_12345
        STRAPI_TELEMETRY_DISABLED: true

    - name: Wait for Strapi to be ready
      run: |
        echo "Waiting for Strapi to start..."
        for i in {1..30}; do
          if curl -s -f http://localhost:1337/admin -o /dev/null; then
            echo "Strapi is ready!"
            exit 0
          fi
          echo "Waiting for Strapi to start... (attempt $i/30)"
          sleep 5
        done
        echo "Strapi failed to start. Last 100 lines of log:"
        tail -n 100 strapi.log || true
        exit 1

    - name: Run Cypress tests
      run: npx cypress run --e2e --browser chrome --headless
      env:
        CYPRESS_BASE_URL: http://localhost:1337
        CYPRESS_ADMIN_EMAIL: admin@example.com
        CYPRESS_ADMIN_PASSWORD: Admin123
        NODE_ENV: test
      continue-on-error: false
      timeout-minutes: 30

    - name: Stop Strapi server
      if: always()
      run: |
        if [ -f strapi.pid ]; then
          echo "Stopping Strapi server (PID: $(cat strapi.pid))"
          kill -9 $(cat strapi.pid) || true
          rm -f strapi.pid
        fi
        # Additional cleanup
        pkill -f 'node.*strapi' || true
